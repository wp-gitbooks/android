书：《Android组件化架构》



# 线索
什么是组件化？为什么要使用组件化？
组件化的优缺点有哪些？
如何设计一个组件化架构？可以讲一下常见的组件化架构方案吗？
如何在组件化架构中处理组件之间的通信问题？
组件化框架中如何处理组件的生命周期？
组件化框架中如何处理组件的路由？
如何避免组件化架构中的代码冗余问题？
如何处理组件化架构中的模块依赖问题？
如何保证组件化架构的安全性？
组件化框架中如何支持组件的热修复？
如何在组件化架构中处理组件之间的资源冲突问题？
组件化框架中如何处理组件的网络请求？
如何在组件化架构中处理组件之间的数据共享问题？
如何在组件化架构中处理组件之间的权限问题？
如何在组件化架构中处理组件之间的多语言支持？
组件化框架中如何支持组件的多进程？
如何在组件化框架中处理组件之间的服务调用问题？
如何在组件化框架中处理组件之间的 UI 统一性问题？
如何在组件化架构中处理组件之间的依赖关系？
如何在组件化框架中处理组件之间的数据传递问题？


# 1 问题
1、层次不清晰，对神策分析 Sa 依赖太重（神策分析 Sa 充当了一个核心层）。
2、ServiceLoader 解耦，Sa 也应该独立出来一个单独的接口。
a、做这个的前提是有基础的组件、模块的通信机制等，否则不太好界定模块之间的接口调用，会导致接口调用很多。



# 2 什么是模块和组件
![](https://cdn.jsdelivr.net/gh/wp3355168/Typora-Picgo-Gitee/img/202204211853654.png)
## 2.1 组件
把重复的代码提取出来合并成为一个个组件，**组件最重要的就是重用（复用）**，位于框架最底层，其他功能都依赖于组件，可供不同功能使用，独立性强。

## 2.2 模块
分属同一功能/业务的代码进行隔离（分装）成**独立的模块，可以独立运行，以页面、功能或其他不同粒度划分程度不同的模块**，位于业务框架层，模块间通过接口调用，目的是降低模块间的耦合，由之前的主应用与模块耦合，变为主应用与接口耦合，接口与模块耦合。


我们可以把软件看做是一辆汽车，开发一款软件的过程就是生产一辆汽车的过程。一辆汽车由车架、发动机、变数箱、车轮等一系列模块组成；同样，一款大型商业软件也是由各个不同的模块组成的。
到了冬天，特别是在北方我们可能需要开着车走雪路，为了安全起见往往我们会将汽车的公路胎升级为雪地胎；轮胎可以很轻易的更换，这就是我们在软件开发领域谈到的低耦合。一个模块的升级替换不会影响到其它模块，也不会受其它模块的限制；同时这也类似于我们在软件开发领域提到的可插拔。


# 3 为什么要使用组件化和模块化
## 3.1 效率
### 3.1.1 开发和调试效率高
多团队并行开发测试；随着功能越来越多，代码结构会越发复杂，要修改某一个小功能，可能要重新翻阅整个项目的代码，把所有相同的地方都修改一遍，重复劳动浪费时间和人力，效率低；使用组件化，每个相同的功能结构都调用同一个组件，只需要修改这个组件，即可全局修改。

### 3.1.2 可维护性强
便于后期代码查找和维护。

### 3.1.3 版本管理更容易
如果由多人协作开发，可以避免代码覆盖和冲突。

## 3.2 结构清晰 
-  模块间解耦、重用；
- 可单独编译打包某一模块，提升开发效率。
业务独立，代码实现分离，不会搅在一起。
模块化是可以独立运行的，如果一个模块产生了bug，不会影响其他模块的调用。

# 4 模块化和组件化区别
## 4.1 组件
就像一个个小的单位，多个组件可以组合成组件库，方便调用和复用，组件间也可以嵌套，小组件组合成大组件

## 4.2 模块
就像是独立的功能和项目（如淘宝：注册、登录、购物、直播...），可以调用组件来组成模块，多个模块可以组合成业务框架。


# 5 模块化设计



# 6 实现方式
## 6.1 事件或广播通信
**EventBus：**?我们非常熟悉的事件总线型的通信框架，非常灵活，采用注解方式实现，但是难以追溯事件。**广播：**?安卓的四大组件之一，在一个模块中发送广播设置数据，在另一个模块中注册广播接收数据，使用广播进行数据传递方式广播相对于其他的方式而言消耗资源较多。

**总结：**?BroadcastReceiver、EventBus，非常灵活，模块之间没有任何的耦合，但是代码的可读性差，难以追溯事件，不是很推荐。

## 6.2 路由通信
模块与模块之间不存在依赖关系，而是各自运作，简单的来说就是映射关系的路由通信，也是目前比较主流的一种方案，比较常用的开源框架是阿里的ARouter。

ARouter典型应用

从外部URL映射到内部页面，以及参数传递与解析跨模块页面跳转，模块间解耦拦截跳转过程处理登陆、埋点等逻辑跨模块API调用，通过控制反转来做组件解耦。


### 6.2.1 面向接口通信
https://chowdera.com/2021/09/20210905181848560c.html

以上几种方式只是简单的介绍，下面就具体说下通过接口解耦通信的方式，首先先看几个问题。

**什么是面向接口编程？**

接口大家都很熟悉，这里所说的面向接口编程，并不只是所谓的 java 中的 interface，而是指超类型，可以是接口也可以是抽象类。

面向接口比面向对象编程是更先进一步编程思想，而是附属于面向对象编程的体系，属于其中一部分，它是面向对象编程体系中的思想精髓之一。面向接口编程它的核心思想是将抽象与实现分离，从组件的级别来设计代码，达到高内聚低耦合的目的。面向接口编程方法是，先定义底层接口模块，也就是?**通信的协议与功能约定**?，是提供方实现对应的功能与能力。在架构中层次分明，不需要关注具体实现，开发中可以通过接口快速制定协议，与提供能力api，对于上层通过接口显露能力，对于下层只需要依赖接口层相当于依赖api。

**面向接口编程的好处？**

灵活性高没有依赖具体的实体，实现层可以任意的更改与切换。在模块化中可以相互依赖service(接口层)或依赖多个。?

**?在模块化中的使用**下面对于接口（interface）或api层统称为service，其含义为服务提供者。
![](https://cdn.jsdelivr.net/gh/wp3355168/Typora-Picgo-Gitee/img/202204221556713.png)

对于，每一个 module 都一个独立的工程结构，每个 module 都有自己的 Service ,来统一暴露当前 module 所拥有能力与向外提供的服务。
![](https://cdn.jsdelivr.net/gh/wp3355168/Typora-Picgo-Gitee/img/202204221556436.png)
对于 module 是在同一个工程里的项目结构，service 可以放到统一的一个 Module 下，我们统称为 Mediator，这样做的目的是为了减少 Module 创建与维护。假设你的工程有20个业务 Module 如果都同时增加一个 service 层就会造成 Module 数量翻一倍。由于这里存入的都一些接口类，也是每个业务 Module 向外提供的服务其体量不会太大，这里并只是一个建议并没有标准的做法。

当然也有更复杂的设计，一个 Module 又分不同的 service 实现如图，这里不在展开细说。
![](https://cdn.jsdelivr.net/gh/wp3355168/Typora-Picgo-Gitee/img/202204221557936.png)

#### 6.2.1.1 实际工程中使用与设计
在实际项目中有很多项目都同时开发两版本Pad与Phone，有的是两独立的工程，有的是在同一个工程内用 flavor 切换不同的工程，下面我就以通过 flavor 切换的工程结构举例。先看下工程的包的结构图：
![](https://cdn.jsdelivr.net/gh/wp3355168/Typora-Picgo-Gitee/img/202204221558907.png)

可以看到 module 结构是分为三个部分，common, pad, phone, 如果每个service 都独立将增加3倍的 Module 数量。
![](https://cdn.jsdelivr.net/gh/wp3355168/Typora-Picgo-Gitee/img/202204221558861.png)

使用一个 Mediator Module 统一管理这这些 service 就很好控制了 module 数量。

#### 6.2.1.2 Service 创建
在 module_mediator 业务 module 下 common，pad、pone 下分别创建ICommonService, IService(pad), IService(phone)。ICommonService：公共服务。IService(pad)：pad服务并继承CommonService。IService(phone)：phone服务并继承CommonService。





# 7 App 模块化
## 7.1 做的事情
须要解决的事情远远不止解耦。业务架构、进程间通讯、资源等处理、解耦方式等都须要解决。

讲下猫眼模块化的整个过程。每个方面没有照搬网络的一些作法，而是分析对比，采用更好的设计方式。好比解耦使用serviceloader，而不是路由进行；


## 7.2 tag
serviceloader解耦，mvp变种框架，模块通讯，lib独立运行，多端复用。sql




# 8 参考
https://juejin.cn/post/6881116198889586701
https://tech.youzan.com/android-mo-kuai-hua-mian-xiang-jie-kou-bian-cheng/
https://zhuanlan.zhihu.com/p/98682826
